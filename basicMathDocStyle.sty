% ==================================================================
% FILE     basicMathDocStyle.sty
% MACHINE  all
% INFO     Preamble for my math documents
%
% DATE     15.02.2017
% OWNER    Bischofberger
% ==================================================================

\ProvidesPackage{basicMathDocStyle}

% depends on my basic style
\RequirePackage{basicDocumentStyle}

% math packages
\RequirePackage{mathtools}
\RequirePackage{amssymb}
\RequirePackage{bm}

% units
\RequirePackage{siunitx}
\sisetup{per-mode=symbol}

% amsmath/mathtools stuff
\allowdisplaybreaks
\DeclarePairedDelimiter\abs{\lvert}{\rvert}

% drawings
\RequirePackage{tikzStyle}

% frames
\RequirePackage[framemethod=tikz]{mdframed}

% exercise enumerations (also loads environ)
\RequirePackage{tasks}
\NewTasks[label-width={1.2em},item-indent={1.5333em}]{Tasks}  % tasks with no left indent


% ----------------------------------------------------------------
% local helper makros
% ----------------------------------------------------------------
\newcommand*{\NotesCalc}{%
  \pgfmathparse{\linewidth - \pgflinewidth}%
  \xdef\myLineWidth{\pgfmathresult}% correct width without line caps
  \pgfmathparse{\myLineWidth / int(\myLineWidth/4mm)}%
  \xdef\sizeOfSquares{\pgfmathresult}% +- 4mm square size
}

% http://tex.stackexchange.com/questions/14512/how-to-define-a-figure-size-so-that-it-consumes-the-rest-of-a-page
\newcommand*\measurepage{\dimexpr\textheight-\pagetotal-\baselineskip\relax}

% http://tex.stackexchange.com/questions/204699/smaller-vertical-space-between-repeated-environments
\newcommand*\SpaceAbove{\ifnum\lastpenalty=12345\vskip-\baselineskip\penalty0\fi}
\newcommand*\SpaceBelow{\par\addvspace{\baselineskip}\penalty12345}


% ----------------------------------------------------------------
% various custom commands and environments...
% ----------------------------------------------------------------
% double underline for end results
\newcommand*{\Result}[1]{\underline{\underline{#1}}}
\newcommand*\bigfrac{\genfrac{}{}{1pt}{0}}   % nested fractions

% sets and constants
\newcommand*{\N}{\mathbb{N}}
\newcommand*{\Z}{\mathbb{Z}}
\newcommand*{\Q}{\mathbb{Q}}
\newcommand*{\R}{\mathbb{R}}
\newcommand*{\C}{\mathbb{C}}
\newcommand*{\Euler}{e}
\newcommand*{\Complex}{i}
\newcommand*{\D}[1]{\mathrm{d}#1}  % dx, dy...
\DeclareMathOperator{\GGT}{ggT}
\DeclareMathOperator{\KGV}{kgV}
\DeclareMathOperator{\Mean}{E}  % mean (stochastics)
\DeclareMathOperator{\Var}{Var} % variance (stochastics)

% Theorems
\newenvironment{Bsp}{\SpaceAbove\BZ\noindent\textbf{Beispiel\enspace}}{\SpaceBelow}
\newenvironment{Def}{\SpaceAbove\BZ\noindent\textbf{Definition\enspace}}{\SpaceBelow}
\newenvironment{Bem}{\SpaceAbove\BZ\noindent\textbf{Bemerkung\enspace}}{\SpaceBelow}

% Notes
\newcommand*{\Notes}[1]{% arg: number of rows
  \BZ[.5]%
  \begin{tikzpicture}[scale=1]
    \NotesCalc
    \draw [line cap=rect, step=\sizeOfSquares pt, gray!50!, thin] 
      (0,0) grid (\myLineWidth pt, {#1 * \sizeOfSquares pt});
  \end{tikzpicture}%
}

% Fill notes paper until end of page
% FIXME: subtract footnote height
\newcommand*{\FillNotes}{%
  \BZ[.5]%
  \begin{tikzpicture}
    \NotesCalc
    \pgfmathparse{int(\measurepage/\sizeOfSquares)}
    \xdef\numberOfRows{\pgfmathresult}
    \draw [line cap=rect, step=\sizeOfSquares pt, gray!50!, thin]
      (0,0) grid (\myLineWidth pt, {\numberOfRows * \sizeOfSquares pt});
  \end{tikzpicture}%
}

% definition frame
\NewEnviron{FrameDef}
{
  \begin{mdframed}[nobreak,linecolor=gray!40!,linewidth=2pt,innertopmargin=1pt,innerbottommargin=0pt]
    \begin{Def}
      \BODY
    \end{Def}
  \end{mdframed}
  \penalty12345
}


% ----------------------------------------------------------------
% all about Exercises...
% ----------------------------------------------------------------
\newcounter{excounter}
\renewcommand*{\theexcounter}{\arabic{excounter}}

\newenvironment{AufgLsg}[1]{% adds label for solution -> see LsgAufg
  \refstepcounter{excounter}%
  \SpaceAbove%
  \label{#1}%
  \BZ\noindent\textbf{Aufgabe~\theexcounter$^{\bm{L}}$\enspace}%
}{\SpaceBelow}

\newenvironment{Aufg}[1][\theexcounter]{% normal
  \ifx\theexcounter#1\refstepcounter{excounter}\fi%
  \SpaceAbove%
  \BZ\noindent\textbf{Aufgabe~#1\enspace}%
}{\SpaceBelow}

\newenvironment{Aufg*}[1][\theexcounter]{% difficult
  \ifx\theexcounter#1\refstepcounter{excounter}\fi%
  \SpaceAbove%
  \BZ\noindent\textbf{Aufgabe~#1*\enspace}%
}{\SpaceBelow}

% LÃ¶sung einer einzelnen Aufgabe.
\newenvironment{LsgAufg}[1]{%
  \textbf{Aufg. \ref{#1} }%
}{\par\addvspace{.5\baselineskip}}

