% ==================================================================
% FILE     myNotes.sty
% MACHINE  all
% INFO     Notes...
%          requires tikz
%
% DATE     12.04.2017
% OWNER    Bischofberger
% ==================================================================

\ProvidesPackage{myNotes}

\RequirePackage{tikz}

% common computations
%
\newcommand*{\NotesCalc}
{%
  \pgfmathparse{\linewidth - \pgflinewidth}%
  \xdef\myLineWidth{\pgfmathresult}% correct width without line caps
  \pgfmathparse{\myLineWidth / int(\myLineWidth/4mm)}%
  \xdef\sizeOfSquares{\pgfmathresult}% +- 4mm square size
}

% measure space remaining on a page
% http://tex.stackexchange.com/questions/14512/how-to-define-a-figure-size-so-that-it-consumes-the-rest-of-a-page
%
\def\@Measurepage{\dimexpr\textheight-\pagetotal-\baselineskip\relax}


% key handling
\pgfkeys
{%
  mynotes/.is family, /mynotes,
  default/.style={space above=1ex,space below=0.3ex},
  space above/.estore in=\myNotesSpaceAbove,
  space below/.estore in=\myNotesSpaceBelow,
}

% Notes[space above=1ex,space below=0.3ex]{10}
% args: #1: options, #2: number of rows
%
\newcommand*{\Notes}[2][]
{%
  \pgfkeys{/mynotes, default, #1}%
  \par\vskip\myNotesSpaceAbove
  \begin{tikzpicture}[scale=1]%
    \NotesCalc%
    \draw [line cap=rect, step=\sizeOfSquares pt, gray!50!, thin]%
      (0,0) grid (\myLineWidth pt, {#2 * \sizeOfSquares pt});%
  \end{tikzpicture}%
  \vskip \myNotesSpaceBelow
}

% \FillNotes[space above=1ex]
% args: #1: options
%
\newcommand*{\FillNotes}[1][]
{%
  \pgfkeys{/mynotes, default, #1}%
  \par\vskip\myNotesSpaceAbove\par
  \begin{tikzpicture}%
    \NotesCalc
    \pgfmathparse{int(\@Measurepage/\sizeOfSquares)}%
    \xdef\numberOfRows{\pgfmathresult}%
    \draw[draw=none] (0,0) -- (0,\@Measurepage); % hack: this aligns notes at the bottom of the page
    \draw [line cap=rect, step=\sizeOfSquares pt, gray!50!, thin]%
      (0,0) grid (\myLineWidth pt, {\numberOfRows * \sizeOfSquares pt});%
  \end{tikzpicture}%
}
