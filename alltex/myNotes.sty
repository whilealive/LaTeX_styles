% ==================================================================
% FILE     myNotes.sty
% MACHINE  all
% INFO     Notes...
%          requires tikz
%
% DATE     12.04.2017
% OWNER    Bischofberger
% ==================================================================
% TODO: add boolean option "exact" to give exact square sizes

\ProvidesPackage{myNotes}

\RequirePackage{tikz}

% key handling
\pgfkeys
{%
  mynotes/.is family, /mynotes,
  default/.style={space above=1ex,space below=0.3ex,square size=4mm},
  space above/.estore in=\myNotesSpaceAbove,
  space below/.estore in=\myNotesSpaceBelow,
  square size/.estore in=\myNotesSquareSize
}

% common computations
%
\newcommand*{\ComputeSizeOfSquares}
{%
  \pgfmathparse{\linewidth - \pgflinewidth}%
  \xdef\myLineWidth{\pgfmathresult}% correct width without line caps
  \pgfmathparse{\myLineWidth / int(\myLineWidth/\myNotesSquareSize)}%
  \xdef\sizeOfSquares{\pgfmathresult}% +- 4mm square size
}

% measure space remaining on a page
% http://tex.stackexchange.com/questions/14512/how-to-define-a-figure-size-so-that-it-consumes-the-rest-of-a-page
%
\def\@Measurepage{\dimexpr\textheight-\pagetotal-\baselineskip\relax}


% Notes[space above=1ex,space below=0.3ex,square size=4mm]{10}
% args: #1: options, #2: number of rows
%
\newcommand*{\Notes}[2][]
{%
  \pgfkeys{/mynotes, default, #1}%
  \par\vskip\myNotesSpaceAbove
  \begin{tikzpicture}[scale=1]%
    \ComputeSizeOfSquares%
    \draw [line cap=rect, step=\sizeOfSquares pt, gray!50!, thin]%
      (0,0) grid (\myLineWidth pt, {#2 * \sizeOfSquares pt});%
  \end{tikzpicture}%
  \vskip \myNotesSpaceBelow
}

% \FillNotes[space above=1ex,square size=4mm]
% args: #1: options
%
\newcommand*{\FillNotes}[1][]
{%
  \pgfkeys{/mynotes, default, #1}%
  \par\vskip\myNotesSpaceAbove\par
  \begin{tikzpicture}%
    \ComputeSizeOfSquares%
    \pgfmathparse{int(\@Measurepage/\sizeOfSquares)}%
    \xdef\numberOfRows{\pgfmathresult}%
    \draw[draw=none] (0,0) -- (0,\@Measurepage); % hack: this aligns notes at the bottom of the page
    \draw [line cap=rect, step=\sizeOfSquares pt, gray!50!, thin]%
      (0,0) grid (\myLineWidth pt, {\numberOfRows * \sizeOfSquares pt});%
  \end{tikzpicture}%
}
